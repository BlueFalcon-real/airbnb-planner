<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Airbnb Setup Assistant - Debug Focus</title>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- html2pdf.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Firebase SDKs - v9 Modular -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getFirestore, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      const firebaseConfig = { // YOUR ACTUAL CONFIG FROM PREVIOUSLY CONFIRMED IMAGE
        apiKey: "AIzaSyCktkFQ_NHhdQKJKK8YY_T96zNA90suvOY",
        authDomain: "airbnb-149c.firebaseapp.com",
        projectId: "airbnb-149c",
        storageBucket: "airbnb-149c.firebasestorage.app",
        messagingSenderId: "744603789878",
        appId: "1:744603789878:web:5bad16fd79ba42e4e10697"
      };

      try {
        console.log("HEAD SCRIPT: Attempting to initialize Firebase...");
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app); 
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseAddDoc = addDoc;
        console.log("HEAD SCRIPT: Firebase Initialized Successfully!");
        document.dispatchEvent(new CustomEvent('firebaseReady'));
      } catch (e) {
        console.error("HEAD SCRIPT - CRITICAL: Error initializing Firebase:", e);
        alert("CRITICAL ERROR: Firebase could not be initialized from head. Check console. Form will not work.");
      }
    </script>

    <style>
        /* --- CSS REMAINS THE SAME as the previous fully styled version --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f4f8; color: #212529; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; line-height: 1.6; }
        #airbnbPlannerContainer { width: 100%; max-width: 750px; background-color: #ffffff; padding: 25px 30px 35px 30px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        #airbnbPlannerContainer h1.main-title { color: #343a40; text-align: center; font-size: 1.85rem; font-weight: 600; margin-bottom: 20px; }
        #stepIndicatorContainer { display: flex; justify-content: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #dee2e6; }
        .step-indicator { height: 36px; width: 36px; border-radius: 50%; background-color: #ffffff; border: 2px solid #007bff; color: #007bff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; margin: 0 10px; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .step-indicator.active { background-color: #007bff; color: #ffffff; border-color: #007bff; }
        .step { display: none; } 
        .step.active { display: block; } 
        #airbnbPlannerContainer .step-card { background-color: #ffffff; border-radius: 8px; padding: 20px 0 10px 0; margin-bottom: 25px; }
        #airbnbPlannerContainer .step-card h2.step-title { color: #343a40; margin-top: 0; margin-bottom: 25px; font-size: 1.5rem; font-weight: 500; display: flex; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #e9f2f9; }
        #airbnbPlannerContainer .step-card h2.step-title i { margin-right: 12px; color: #007bff; font-size: 0.95em; }
        #airbnbPlannerContainer .form-group, #airbnbPlannerContainer .form-group-with-icon { margin-bottom: 22px; }
        #airbnbPlannerContainer .form-group label, #airbnbPlannerContainer .form-group-with-icon label { display: block; font-weight: 500; margin-bottom: 8px; color: #495057; font-size: 0.95rem; }
        #airbnbPlannerContainer .form-group input[type="text"], #airbnbPlannerContainer .form-group input[type="email"], #airbnbPlannerContainer .form-group input[type="tel"], #airbnbPlannerContainer .form-group input[type="number"], #airbnbPlannerContainer .form-group select, .input-icon-wrapper input { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; font-size: 1rem; box-sizing: border-box; color: #212529; background-color: #ffffff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        #airbnbPlannerContainer .form-group input:focus, #airbnbPlannerContainer .form-group select:focus, .input-icon-wrapper input:focus { border-color: #80bdff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); outline: none; }
        #airbnbPlannerContainer .input-icon-wrapper { display: flex; align-items: center; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #ffffff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        #airbnbPlannerContainer .input-icon-wrapper:focus-within { border-color: #80bdff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        #airbnbPlannerContainer .input-icon-wrapper i.fa-input-icon { padding: 0 10px 0 12px; color: #007bff; font-size: 0.95rem; border-right: 1px solid #e0e0e0; display: flex; align-items: center; height: 38px; }
        #airbnbPlannerContainer .input-icon-wrapper input { flex-grow: 1; border: none; border-radius: 0 0.25rem 0.25rem 0; background-color: transparent; box-shadow: none; outline: none; }
        #airbnbPlannerContainer .radio-group label { margin-right: 20px; font-weight: normal; cursor: pointer; display: inline-flex; align-items: center; color: #495057; }
        #airbnbPlannerContainer .radio-group input[type="radio"] { margin-right: 8px; transform: scale(1.1); accent-color: #007bff; }
        #airbnbPlannerContainer .info-display { background-color: #e9f2f9; padding: 12px 15px; border-radius: 0.25rem; margin-top: 15px; border: 1px solid #d0e0ed; }
        #airbnbPlannerContainer .info-display p { margin: 8px 0; font-size: 0.95rem; color: #212529; }
        #airbnbPlannerContainer .info-display strong { color: #005a9e; }
        #airbnbPlannerContainer .navigation-buttons { display: flex; justify-content: space-between; margin-top: 30px; align-items: center; }
        #airbnbPlannerContainer .navigation-buttons .button-group { display: flex; gap: 10px; }
        button.btn { padding: 10px 22px; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: background-color 0.2s ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; letter-spacing: 0.5px; }
        button.btn i { margin-right: 8px; } button.btn i.fa-arrow-right { margin-left: 8px; margin-right: 0; }
        button.btn.primary { background-color: #007bff; color: #ffffff; }
        button.btn.primary:hover { background-color: #0056b3; transform: translateY(-1px); }
        button.btn.secondary { background-color: #6c757d; color: #ffffff; }
        button.btn.secondary:hover { background-color: #5a6268; transform: translateY(-1px); }
        button.btn.prev { background-color: #f8f9fa; color: #343a40; border: 1px solid #ced4da; }
        button.btn.prev:hover { background-color: #e9ecef; border-color: #adb5bd; transform: translateY(-1px); }
        button.btn:disabled { background: #ccc; cursor: not-allowed; }
        #airbnbPlannerContainer .summary-note { font-size: 0.9em; color: #495057; margin-top: 15px; padding: 10px 12px; background-color: #fff3cd; border-left: 4px solid #ffeeba; border-radius: 0.25rem; }
        @media (max-width: 600px) { body { padding: 15px 10px; } #airbnbPlannerContainer { padding: 20px 15px; } #stepIndicatorContainer { margin: 0 0 25px 0; flex-wrap: wrap; } .step-indicator { height: 32px; width: 32px; font-size: 0.9rem; margin: 5px; } #airbnbPlannerContainer .step-card h2.step-title { font-size: 1.35rem; } #airbnbPlannerContainer .input-icon-wrapper i.fa-input-icon { height: 38px; } #airbnbPlannerContainer .navigation-buttons { flex-direction: column-reverse; gap: 12px; } #airbnbPlannerContainer .navigation-buttons .button-group { flex-direction: column; width: 100%; gap: 10px; } #airbnbPlannerContainer button { width: 100%; } #airbnbPlannerContainer .navigation-buttons .prev-btn { margin-bottom: 0; } }
    </style>
</head>
<body>
    <div id="airbnbPlannerContainer">
        <!-- HTML structure for steps (same as previous version) -->
        <h1 class="main-title">Airbnb Setup Assistant</h1>
        <div id="stepIndicatorContainer"> <span class="step-indicator active" data-step="1">1</span> <span class="step-indicator" data-step="2">2</span> <span class="step-indicator" data-step="3">3</span> <span class="step-indicator" data-step="4">4</span> </div>
        <form id="investmentForm" onsubmit="return false;">
            <div class="step step-card active" id="step1"> <h2 class="step-title"><i class="fas fa-user-circle"></i> Personal Information</h2> <div class="form-group-with-icon"> <label for="full_name">Full Name:</label> <div class="input-icon-wrapper"> <i class="fas fa-user fa-input-icon"></i> <input type="text" id="full_name" required/></div> </div> <div class="form-group-with-icon"> <label for="email">Email:</label> <div class="input-icon-wrapper"> <i class="fas fa-envelope fa-input-icon"></i> <input type="email" id="email" required/></div> </div> <div class="form-group-with-icon"> <label for="phone">Phone (Optional):</label> <div class="input-icon-wrapper"> <i class="fas fa-phone fa-input-icon"></i> <input type="tel" id="phone"/></div> </div> <div class="navigation-buttons"> <span></span> <button type="button" class="btn primary next-btn-js" data-targetstep="2">Next <i class="fas fa-arrow-right"></i></button> </div> </div>
            <div class="step step-card" id="step2"> <h2 class="step-title"><i class="fas fa-home"></i> Apartment Selection</h2> <div class="form-group"> <label>Apartment Type:</label> <div class="radio-group"> <input type="radio" id="studio_type" name="apartment_type" value="Studio" checked /> <label for="studio_type">Studio</label> <input type="radio" id="one_bedroom_type" name="apartment_type" value="1-Bedroom" /> <label for="one_bedroom_type">1-Bedroom</label> </div> </div> <div class="form-group"> <label for="location_dropdown">Location:</label> <select id="location_dropdown" required></select> </div> <div id="apartment_info" class="info-display" style="margin-top: 10px; display: none;"> <p><strong>Rent:</strong> KES <span id="rent_display">N/A</span></p> <p><strong>Deposit:</strong> KES <span id="deposit_display">N/A</span></p> </div> <div class="navigation-buttons"> <button type="button" class="btn prev prev-btn-js" data-targetstep="1"><i class="fas fa-arrow-left"></i> Previous</button> <button type="button" class="btn primary next-btn-js" data-targetstep="3">Next <i class="fas fa-arrow-right"></i></button> </div> </div>
            <div class="step step-card" id="step3"> <h2 class="step-title"><i class="fas fa-hand-holding-usd"></i> Financing & Loan</h2> <div class="form-group"> <label for="institution_dropdown">Select Institution:</label> <select id="institution_dropdown" required></select> </div> <div class="form-group"> <label for="loan_dropdown">Select Loan Product:</label> <select id="loan_dropdown" required></select> </div> <div id="loan_info" class="info-display" style="display: none;"> <p><strong>Loan Limit:</strong> <span id="loan_limit_display">N/A</span></p> <p><strong>Interest Rate:</strong> <span id="interest_rate_display">N/A</span>%</p> <p><strong>Loan Term:</strong> <span id="loan_term_display">N/A</span> months</p> <p><strong>Multiplier:</strong> <span id="loan_multiplier_display">N/A</span></p> </div> <div class="navigation-buttons"> <button type="button" class="btn prev prev-btn-js" data-targetstep="2"><i class="fas fa-arrow-left"></i> Previous</button> <button type="button" class="btn primary next-btn-js" data-targetstep="4">Next <i class="fas fa-arrow-right"></i></button> </div> </div>
            <div class="step step-card" id="step4"> <h2 class="step-title"><i class="fas fa-calculator"></i> Financial Summary</h2> <div class="form-group"> <label for="user_capital">Your Available Capital (KES):</label> <input type="number" id="user_capital" min="0" required/> </div> <div id="summaryDetails" class="info-display"> <p><strong>Total Setup Cost:</strong> KES <span id="total_cost_display">260,000</span></p> <p><strong>Loan Required:</strong> KES <span id="loan_required_display">N/A</span></p> <p><strong>Potential Loan You Qualify For:</strong> KES <span id="qualified_amount_display">N/A</span></p> </div> <p class="summary-note">This is an estimate. Actual loan approval is subject to assessment.</p> <div class="navigation-buttons"> <button type="button" class="btn prev prev-btn-js" data-targetstep="3"><i class="fas fa-arrow-left"></i> Previous</button> <div class="button-group"> <button type="button" class="btn primary" id="saveAndDownloadPdfBtn"><i class="fas fa-file-pdf"></i> Save & Download PDF</button> <button type="button" class="btn secondary" id="emailPlanBtn"><i class="fas fa-paper-plane"></i> Email Plan</button> </div> </div> </div>
        </form>
    </div>

    <script type="module">
    // --- MODULE-SCOPED VARIABLES ---
    // All DOM elements are declared here
    let formContainer;
    const stepsNodeList = [];
    const stepIndicatorsNodeList = [];

    // All form input elements
    let apartmentTypeRadiosNodeList, locationDropdown, institutionDropdown, loanDropdown, userCapitalInput;
    let saveAndDownloadPdfBtnNode, emailPlanBtnNode;

    // State Management: The single source of truth for which step is visible
    let currentStepIndex = 0;

    // Data placeholders
    let allApartments = [];
    let allLoanProducts = [];
    let selectedApartmentData = null;
    let selectedLoanData = null;
    const FIXED_TOTAL_COST = 260000;

    // --- CORE NAVIGATION LOGIC (Inspired by your working example) ---

    /**
     * This function is the heart of the navigation. It loops through all steps
     * and indicators, showing only the one at the currentStepIndex and hiding all others.
     * This is the robust pattern from your example.
     */
    function updateStepVisibility() {
        stepsNodeList.forEach((step, index) => {
            step.classList.toggle('active', index === currentStepIndex);
        });
        stepIndicatorsNodeList.forEach((indicator, index) => {
            indicator.classList.toggle('active', index === currentStepIndex);
        });
    }

    /**
     * This function controls the navigation flow.
     * It validates the current step before proceeding.
     */
    function navigateToStep(targetStepNum) {
        const targetStepIndex = targetStepNum - 1;

        // Boundary check to prevent errors
        if (targetStepIndex < 0 || targetStepIndex >= stepsNodeList.length) {
            console.error("Invalid navigation target:", targetStepIndex);
            return;
        }

        // If moving forward, validate the current step first
        if (targetStepIndex > currentStepIndex) {
            if (!validateStep(currentStepIndex)) {
                return; // Stop if validation fails
            }
        }

        // Update the state
        currentStepIndex = targetStepIndex;

        // Update the UI based on the new state
        updateStepVisibility();

        // Scroll to the top of the form for a better user experience
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- VALIDATION & OTHER FUNCTIONS ---

    function validateStep(stepIndexToValidate) {
        // This function remains the same as it correctly checks inputs
        const fullNameInput = document.getElementById('full_name');
        const emailInput = document.getElementById('email');

        if (stepIndexToValidate === 0) { // Step 1
            if (!fullNameInput.value.trim() || !emailInput.value.trim()) {
                alert("Please enter your Full Name and Email.");
                return false;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim())) {
                alert("Please enter a valid Email address.");
                return false;
            }
        } else if (stepIndexToValidate === 1) { // Step 2
             if (!selectedApartmentData) { alert("Please select an apartment."); return false; }
        } else if (stepIndexToValidate === 2) { // Step 3
            if (!selectedLoanData) { alert("Please select a loan product."); return false; }
        }
        return true;
    }

    // (Your other helper functions like fetchAppData, populateLocations, etc., go here)
    async function fetchAppData() { /* ... Your data fetching logic ... */ }
    function populateLocations() { /* ... Your logic ... */ }
    function displayApartmentInfo() { /* ... Your logic ... */ }
    function populateInstitutionsDropdown() { /* ... Your logic ... */ }
    function populateLoanProductsDropdown() { /* ... Your logic ... */ }
    function displayLoanInfo() { /* ... Your logic ... */ }
    function updateFinancialSummary() { /* ... Your logic ... */ }
    async function saveAndDownload() { /* ... Your logic ... */ }


    // --- MAIN INITIALIZER ---

    function mainAppInitializer() {
        console.log("App Initializing...");

        // --- 1. Query all DOM elements ---
        formContainer = document.getElementById('airbnbPlannerContainer');
        document.querySelectorAll('.step').forEach(step => stepsNodeList.push(step));
        document.querySelectorAll('.step-indicator').forEach(ind => stepIndicatorsNodeList.push(ind));

        apartmentTypeRadiosNodeList = document.querySelectorAll('input[name="apartment_type"]');
        locationDropdown = document.getElementById('location_dropdown');
        institutionDropdown = document.getElementById('institution_dropdown');
        loanDropdown = document.getElementById('loan_dropdown');
        userCapitalInput = document.getElementById('user_capital');
        saveAndDownloadPdfBtnNode = document.getElementById('saveAndDownloadPdfBtn');
        emailPlanBtnNode = document.getElementById('emailPlanBtn');
        document.getElementById('total_cost_display').innerText = FIXED_TOTAL_COST.toLocaleString();

        // --- 2. Attach all event listeners ---

        // Navigation Buttons (Next and Previous)
        document.querySelectorAll('.next-btn-js, .prev-btn-js').forEach(button => {
            button.addEventListener('click', function() {
                const targetStep = parseInt(this.dataset.targetstep, 10);
                if (!isNaN(targetStep)) {
                    navigateToStep(targetStep);
                }
            });
        });

        // Other form element listeners
        apartmentTypeRadiosNodeList.forEach(radio => radio.addEventListener('change', populateLocations));
        locationDropdown.addEventListener('change', displayApartmentInfo);
        institutionDropdown.addEventListener('change', populateLoanProductsDropdown);
        loanDropdown.addEventListener('change', displayLoanInfo);
        userCapitalInput.addEventListener('input', updateFinancialSummary);
        saveAndDownloadPdfBtnNode.addEventListener('click', saveAndDownload);

        // --- 3. Initial state setup ---
        if (window.db) {
            console.log("Firebase ready. Fetching data...");
            fetchAppData();
        } else {
            console.error("Critical: Firebase not ready.");
            alert("Error: Could not connect to the database.");
        }

        // Ensure the initial view is correct.
        updateStepVisibility();
        updateFinancialSummary();
        console.log("App Initialized Successfully.");
    }

    // Start the application once Firebase is ready.
    document.addEventListener('firebaseReady', mainAppInitializer);

</script>
</body>
</html>