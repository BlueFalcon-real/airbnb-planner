<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Airbnb Setup Assistant - Debug Focus</title>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- html2pdf.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Firebase SDKs - v9 Modular -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getFirestore, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      const firebaseConfig = { // YOUR ACTUAL CONFIG FROM PREVIOUSLY CONFIRMED IMAGE
        apiKey: "AIzaSyCktkFQ_NHhdQKJKK8YY_T96zNA90suvOY",
        authDomain: "airbnb-149c.firebaseapp.com",
        projectId: "airbnb-149c",
        storageBucket: "airbnb-149c.firebasestorage.app",
        messagingSenderId: "744603789878",
        appId: "1:744603789878:web:5bad16fd79ba42e4e10697"
      };

      try {
        console.log("HEAD SCRIPT: Attempting to initialize Firebase...");
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app); 
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseAddDoc = addDoc;
        console.log("HEAD SCRIPT: Firebase Initialized Successfully!");
        document.dispatchEvent(new CustomEvent('firebaseReady'));
      } catch (e) {
        console.error("HEAD SCRIPT - CRITICAL: Error initializing Firebase:", e);
        alert("CRITICAL ERROR: Firebase could not be initialized from head. Check console. Form will not work.");
      }
    </script>

    <style>
        /* --- CSS REMAINS THE SAME as the previous fully styled version --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f4f8; color: #212529; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; line-height: 1.6; }
        #airbnbPlannerContainer { width: 100%; max-width: 750px; background-color: #ffffff; padding: 25px 30px 35px 30px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        #airbnbPlannerContainer h1.main-title { color: #343a40; text-align: center; font-size: 1.85rem; font-weight: 600; margin-bottom: 20px; }
        #stepIndicatorContainer { display: flex; justify-content: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #dee2e6; }
        .step-indicator { height: 36px; width: 36px; border-radius: 50%; background-color: #ffffff; border: 2px solid #007bff; color: #007bff; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; margin: 0 10px; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .step-indicator.active { background-color: #007bff; color: #ffffff; border-color: #007bff; }
        .step { display: none; } 
        .step.active { display: block; } 
        #airbnbPlannerContainer .step-card { background-color: #ffffff; border-radius: 8px; padding: 20px 0 10px 0; margin-bottom: 25px; }
        #airbnbPlannerContainer .step-card h2.step-title { color: #343a40; margin-top: 0; margin-bottom: 25px; font-size: 1.5rem; font-weight: 500; display: flex; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #e9f2f9; }
        #airbnbPlannerContainer .step-card h2.step-title i { margin-right: 12px; color: #007bff; font-size: 0.95em; }
        #airbnbPlannerContainer .form-group, #airbnbPlannerContainer .form-group-with-icon { margin-bottom: 22px; }
        #airbnbPlannerContainer .form-group label, #airbnbPlannerContainer .form-group-with-icon label { display: block; font-weight: 500; margin-bottom: 8px; color: #495057; font-size: 0.95rem; }
        #airbnbPlannerContainer .form-group input[type="text"], #airbnbPlannerContainer .form-group input[type="email"], #airbnbPlannerContainer .form-group input[type="tel"], #airbnbPlannerContainer .form-group input[type="number"], #airbnbPlannerContainer .form-group select, .input-icon-wrapper input { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; font-size: 1rem; box-sizing: border-box; color: #212529; background-color: #ffffff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        #airbnbPlannerContainer .form-group input:focus, #airbnbPlannerContainer .form-group select:focus, .input-icon-wrapper input:focus { border-color: #80bdff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); outline: none; }
        #airbnbPlannerContainer .input-icon-wrapper { display: flex; align-items: center; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #ffffff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        #airbnbPlannerContainer .input-icon-wrapper:focus-within { border-color: #80bdff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        #airbnbPlannerContainer .input-icon-wrapper i.fa-input-icon { padding: 0 10px 0 12px; color: #007bff; font-size: 0.95rem; border-right: 1px solid #e0e0e0; display: flex; align-items: center; height: 38px; }
        #airbnbPlannerContainer .input-icon-wrapper input { flex-grow: 1; border: none; border-radius: 0 0.25rem 0.25rem 0; background-color: transparent; box-shadow: none; outline: none; }
        #airbnbPlannerContainer .radio-group label { margin-right: 20px; font-weight: normal; cursor: pointer; display: inline-flex; align-items: center; color: #495057; }
        #airbnbPlannerContainer .radio-group input[type="radio"] { margin-right: 8px; transform: scale(1.1); accent-color: #007bff; }
        #airbnbPlannerContainer .info-display { background-color: #e9f2f9; padding: 12px 15px; border-radius: 0.25rem; margin-top: 15px; border: 1px solid #d0e0ed; }
        #airbnbPlannerContainer .info-display p { margin: 8px 0; font-size: 0.95rem; color: #212529; }
        #airbnbPlannerContainer .info-display strong { color: #005a9e; }
        #airbnbPlannerContainer .navigation-buttons { display: flex; justify-content: space-between; margin-top: 30px; align-items: center; }
        #airbnbPlannerContainer .navigation-buttons .button-group { display: flex; gap: 10px; }
        button.btn { padding: 10px 22px; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: background-color 0.2s ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; letter-spacing: 0.5px; }
        button.btn i { margin-right: 8px; } button.btn i.fa-arrow-right { margin-left: 8px; margin-right: 0; }
        button.btn.primary { background-color: #007bff; color: #ffffff; }
        button.btn.primary:hover { background-color: #0056b3; transform: translateY(-1px); }
        button.btn.secondary { background-color: #6c757d; color: #ffffff; }
        button.btn.secondary:hover { background-color: #5a6268; transform: translateY(-1px); }
        button.btn.prev { background-color: #f8f9fa; color: #343a40; border: 1px solid #ced4da; }
        button.btn.prev:hover { background-color: #e9ecef; border-color: #adb5bd; transform: translateY(-1px); }
        button.btn:disabled { background: #ccc; cursor: not-allowed; }
        #airbnbPlannerContainer .summary-note { font-size: 0.9em; color: #495057; margin-top: 15px; padding: 10px 12px; background-color: #fff3cd; border-left: 4px solid #ffeeba; border-radius: 0.25rem; }
        @media (max-width: 600px) { body { padding: 15px 10px; } #airbnbPlannerContainer { padding: 20px 15px; } #stepIndicatorContainer { margin: 0 0 25px 0; flex-wrap: wrap; } .step-indicator { height: 32px; width: 32px; font-size: 0.9rem; margin: 5px; } #airbnbPlannerContainer .step-card h2.step-title { font-size: 1.35rem; } #airbnbPlannerContainer .input-icon-wrapper i.fa-input-icon { height: 38px; } #airbnbPlannerContainer .navigation-buttons { flex-direction: column-reverse; gap: 12px; } #airbnbPlannerContainer .navigation-buttons .button-group { flex-direction: column; width: 100%; gap: 10px; } #airbnbPlannerContainer button { width: 100%; } #airbnbPlannerContainer .navigation-buttons .prev-btn { margin-bottom: 0; } }
    </style>
</head>
<body>
    <div id="airbnbPlannerContainer">
        <!-- HTML structure for steps (same as previous version) -->
        <h1 class="main-title">Airbnb Setup Assistant</h1>
        <div id="stepIndicatorContainer"> <span class="step-indicator active" data-step="1">1</span> <span class="step-indicator" data-step="2">2</span> <span class="step-indicator" data-step="3">3</span> <span class="step-indicator" data-step="4">4</span> </div>
        <form id="investmentForm" onsubmit="return false;">
            <div class="step step-card active" id="step1"> <h2 class="step-title"><i class="fas fa-user-circle"></i> Personal Information</h2> <div class="form-group-with-icon"> <label for="full_name">Full Name:</label> <div class="input-icon-wrapper"> <i class="fas fa-user fa-input-icon"></i> <input type="text" id="full_name" required/></div> </div> <div class="form-group-with-icon"> <label for="email">Email:</label> <div class="input-icon-wrapper"> <i class="fas fa-envelope fa-input-icon"></i> <input type="email" id="email" required/></div> </div> <div class="form-group-with-icon"> <label for="phone">Phone (Optional):</label> <div class="input-icon-wrapper"> <i class="fas fa-phone fa-input-icon"></i> <input type="tel" id="phone"/></div> </div> <div class="navigation-buttons"> <span></span> <button type="button" class="btn primary next-btn-js" data-targetstep="2">Next <i class="fas fa-arrow-right"></i></button> </div> </div>
            <div class="step step-card" id="step2"> <h2 class="step-title"><i class="fas fa-home"></i> Apartment Selection</h2> <div class="form-group"> <label>Apartment Type:</label> <div class="radio-group"> <input type="radio" id="studio_type" name="apartment_type" value="Studio" checked /> <label for="studio_type">Studio</label> <input type="radio" id="one_bedroom_type" name="apartment_type" value="1-Bedroom" /> <label for="one_bedroom_type">1-Bedroom</label> </div> </div> <div class="form-group"> <label for="location_dropdown">Location:</label> <select id="location_dropdown" required></select> </div> <div id="apartment_info" class="info-display" style="margin-top: 10px; display: none;"> <p><strong>Rent:</strong> KES <span id="rent_display">N/A</span></p> <p><strong>Deposit:</strong> KES <span id="deposit_display">N/A</span></p> </div> <div class="navigation-buttons"> <button type="button" class="btn prev prev-btn-js" data-targetstep="1"><i class="fas fa-arrow-left"></i> Previous</button> <button type="button" class="btn primary next-btn-js" data-targetstep="3">Next <i class="fas fa-arrow-right"></i></button> </div> </div>
            <div class="step step-card" id="step3"> <h2 class="step-title"><i class="fas fa-hand-holding-usd"></i> Financing & Loan</h2> <div class="form-group"> <label for="institution_dropdown">Select Institution:</label> <select id="institution_dropdown" required></select> </div> <div class="form-group"> <label for="loan_dropdown">Select Loan Product:</label> <select id="loan_dropdown" required></select> </div> <div id="loan_info" class="info-display" style="display: none;"> <p><strong>Loan Limit:</strong> <span id="loan_limit_display">N/A</span></p> <p><strong>Interest Rate:</strong> <span id="interest_rate_display">N/A</span>%</p> <p><strong>Loan Term:</strong> <span id="loan_term_display">N/A</span> months</p> <p><strong>Multiplier:</strong> <span id="loan_multiplier_display">N/A</span></p> </div> <div class="navigation-buttons"> <button type="button" class="btn prev prev-btn-js" data-targetstep="2"><i class="fas fa-arrow-left"></i> Previous</button> <button type="button" class="btn primary next-btn-js" data-targetstep="4">Next <i class="fas fa-arrow-right"></i></button> </div> </div>
            <div class="step step-card" id="step4"> <h2 class="step-title"><i class="fas fa-calculator"></i> Financial Summary</h2> <div class="form-group"> <label for="user_capital">Your Available Capital (KES):</label> <input type="number" id="user_capital" min="0" required/> </div> <div id="summaryDetails" class="info-display"> <p><strong>Total Setup Cost:</strong> KES <span id="total_cost_display">260,000</span></p> <p><strong>Loan Required:</strong> KES <span id="loan_required_display">N/A</span></p> <p><strong>Potential Loan You Qualify For:</strong> KES <span id="qualified_amount_display">N/A</span></p> </div> <p class="summary-note">This is an estimate. Actual loan approval is subject to assessment.</p> <div class="navigation-buttons"> <button type="button" class="btn prev prev-btn-js" data-targetstep="3"><i class="fas fa-arrow-left"></i> Previous</button> <div class="button-group"> <button type="button" class="btn primary" id="saveAndDownloadPdfBtn"><i class="fas fa-file-pdf"></i> Save & Download PDF</button> <button type="button" class="btn secondary" id="emailPlanBtn"><i class="fas fa-paper-plane"></i> Email Plan</button> </div> </div> </div>
        </form>
    </div>

    <script type="module">
        // Declare module-scoped variables (these will be assigned in mainAppInitializer)
        let formContainer, apartmentTypeRadiosNodeList, locationDropdown, apartmentInfoDiv, rentDisplay, depositDisplay;
        let institutionDropdown, loanDropdown, loanInfoDiv, loanLimitDisplay, interestRateDisplay, loanTermDisplay, loanMultiplierDisplay;
        let userCapitalInput, totalCostDisplay, loanRequiredDisplay, qualifiedAmountDisplay;
        let saveAndDownloadPdfBtnNode, emailPlanBtnNode;
        
        const stepsNodeList = []; 
        const stepIndicatorsNodeList = []; 
        let currentStepIndex = 0; 

        let allApartments = []; 
        let allLoanProducts = []; 

        let selectedApartmentData = null;
        let selectedLoanData = null;

        const FIXED_TOTAL_COST = 260000;

        // --- FUNCTION DEFINITIONS ---
        function validateStep(stepIndexToValidate) {
            console.log("Validating step index:", stepIndexToValidate);
            // Make sure elements exist before accessing .value
            const fullNameInput = document.getElementById('full_name');
            const emailInput = document.getElementById('email');

            if (stepIndexToValidate === 0) { // Step 1: Personal Info
                if (!fullNameInput || !emailInput) { console.error("validateStep: Name or email input DOM element not found."); return false;}
                const fullName = fullNameInput.value.trim();
                const email = emailInput.value.trim();
                if (!fullName || !email) { alert("Please enter your Full Name and Email."); return false; }
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(email)) { alert("Please enter a valid Email address."); return false; }
            } else if (stepIndexToValidate === 1) { // Step 2: Apartment
                 if (!selectedApartmentData) { alert("Please select an apartment type and location."); return false; }
            } else if (stepIndexToValidate === 2) { // Step 3: Financing
                if (!selectedLoanData) { alert("Please select a financial institution and loan product."); return false; }
            }
            console.log("Step", stepIndexToValidate + 1, "validation passed.");
            return true; 
        }
        
        function _navigateToStep(targetStepNum) { // Underscore to indicate it's internal, called by listeners
            const targetStepIndex = targetStepNum - 1; 

            if (!stepsNodeList || stepsNodeList.length === 0) { 
                console.error("_navigateToStep: stepsNodeList is not populated or empty."); return; 
            }
            if (targetStepIndex < 0 || targetStepIndex >= stepsNodeList.length) { 
                console.error("_navigateToStep: Invalid targetStepIndex:", targetStepIndex); return; 
            }

            console.log(`_navigateToStep: Current index: ${currentStepIndex}, Target index: ${targetStepIndex} (Target Step Num: ${targetStepNum})`);

            if (targetStepIndex > currentStepIndex) { 
                if (!validateStep(currentStepIndex)) {
                    console.log("_navigateToStep: Validation failed for current step, navigation stopped.");
                    return; 
                }
            }

            if(stepsNodeList[currentStepIndex]) stepsNodeList[currentStepIndex].classList.remove('active');
            if(stepIndicatorsNodeList[currentStepIndex]) stepIndicatorsNodeList[currentStepIndex].classList.remove('active');
            
            currentStepIndex = targetStepIndex; 
            
            if(stepsNodeList[currentStepIndex]) stepsNodeList[currentStepIndex].classList.add('active');
            if(stepIndicatorsNodeList[currentStepIndex]) stepIndicatorsNodeList[currentStepIndex].classList.add('active');
            console.log("_navigateToStep: Navigated to step index:", currentStepIndex);
            
            if (formContainer) {  formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); } 
            else { window.scrollTo(0,0); }
        }
        
        async function fetchAppData() { /* ... (Paste your complete, correct fetchAppData function here) ... */ }
        function populateLocations() { /* ... (Paste your complete, correct populateLocations function here) ... */ }
        function displayApartmentInfo() { /* ... (Paste your complete, correct displayApartmentInfo function here) ... */ }
        function populateInstitutionsDropdown() { /* ... (Paste your complete, correct populateInstitutionsDropdown function here) ... */ }
        function populateLoanProductsDropdown() { /* ... (Paste your complete, correct populateLoanProductsDropdown function here) ... */ }
        function displayLoanInfo() { /* ... (Paste your complete, correct displayLoanInfo function here) ... */ }
        function updateFinancialSummary() { /* ... (Paste your complete, correct updateFinancialSummary function here) ... */ }
        function generatePDFContentHTML() { /* ... (Paste your complete, correct generatePDFContentHTML function here) ... */ }
        async function saveAndDownload() { /* ... (Paste your complete, correct saveAndDownload function here, ensuring it uses window.db) ... */ }
        

        // --- mainAppInitializer Function ---
        function mainAppInitializer() {
            console.log("mainAppInitializer: Script starting. Initializing DOM elements and listeners.");

            // Initialize DOM element variables
            formContainer = document.getElementById('airbnbPlannerContainer');
            apartmentTypeRadiosNodeList = document.querySelectorAll('input[name="apartment_type"]');
            locationDropdown = document.getElementById('location_dropdown');
            apartmentDetailsDiv = document.getElementById('apartment_info');
            aptRentSpan = document.getElementById('rent_display');
            aptDepositSpan = document.getElementById('deposit_display');
            institutionDropdown = document.getElementById('institution_dropdown');
            loanDropdown = document.getElementById('loan_dropdown');
            loanInfoDiv = document.getElementById('loan_info');
            loanLimitDisplay = document.getElementById('loan_limit_display');
            interestRateDisplay = document.getElementById('interest_rate_display');
            loanTermDisplay = document.getElementById('loan_term_display');
            loanMultiplierDisplay = document.getElementById('loan_multiplier_display');
            userCapitalInput = document.getElementById('user_capital');
            totalCostDisplay = document.getElementById('total_cost_display');
            loanRequiredDisplay = document.getElementById('loan_required_display');
            qualifiedAmountDisplay = document.getElementById('qualified_amount_display');
            saveAndDownloadPdfBtnNode = document.getElementById('saveAndDownloadPdfBtn');
            emailPlanBtnNode = document.getElementById('emailPlanBtn');
            
            // Populate steps and stepIndicators arrays
            stepsNodeList.length = 0; 
            stepIndicatorsNodeList.length = 0; 
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) stepsNodeList.push(stepEl); else console.warn(`mainAppInitializer: Step element step${i} not found.`);
                const indicatorEl = document.querySelector(`.step-indicator[data-step="${i}"]`);
                if (indicatorEl) stepIndicatorsNodeList.push(indicatorEl); else console.warn(`mainAppInitializer: Indicator for step ${i} not found.`);
            }
            console.log("mainAppInitializer: Steps array length:", stepsNodeList.length, stepsNodeList);
            console.log("mainAppInitializer: StepIndicators array length:", stepIndicatorsNodeList.length, stepIndicatorsNodeList);
            
            // Initial UI Setup for steps
            if (stepsNodeList.length > 0 && stepsNodeList[0]) {
                 stepsNodeList.forEach((step, index) => { 
                    if(step) step.style.display = index === 0 ? 'block' : 'none'; // Ensure only first step is active
                });
                if (stepIndicatorsNodeList.length > 0 && stepIndicatorsNodeList[0]) {
                     stepIndicatorsNodeList.forEach((ind, index) => ind.classList.toggle('active', index === 0));
                }
            } else { console.error("mainAppInitializer: Steps array is empty. Cannot set initial display properly."); }
            
            // Attach Event Listeners to Navigation Buttons
document.querySelectorAll('.next-btn-js').forEach(button => {
    button.addEventListener('click', function () {
        const targetStep = parseInt(this.dataset.targetstep);
        if (!isNaN(targetStep)) {
            navigateToStep(targetStep);
        }
    });
});
document.querySelectorAll('.prev-btn-js').forEach(button => {
    button.addEventListener('click', function () {
        const targetStep = parseInt(this.dataset.targetstep);
        if (!isNaN(targetStep)) {
            navigateToStep(targetStep);
        }
    });
});

            // Attach Other Event Listeners
            if(apartmentTypeRadiosNodeList) apartmentTypeRadiosNodeList.forEach(radio => radio.addEventListener('change', populateLocations));
            if(locationDropdown) locationDropdown.addEventListener('change', displayApartmentInfo);
            if(institutionDropdown) institutionDropdown.addEventListener('change', populateLoanProductsDropdown);
            if(loanDropdown) loanDropdown.addEventListener('change', displayLoanInfo);
            if(userCapitalInput) userCapitalInput.addEventListener('input', updateFinancialSummary);
            if(saveAndDownloadPdfBtnNode) saveAndDownloadPdfBtnNode.addEventListener('click', saveAndDownload);
            if(emailPlanBtnNode) { /* Email placeholder or actual logic */ }

            // Initial Data Population
            if (window.db) { 
                console.log("mainAppInitializer: Firebase client (window.db) confirmed. Fetching app data...");
                fetchAppData(); 
            } else {
                console.error("mainAppInitializer: Firebase client (window.db) is NOT defined at time of app data fetch. This should not happen if firebaseReady event worked.");
                alert("Critical error: Database connection is not available for data fetching.");
            }
            if(totalCostDisplay) totalCostDisplay.innerText = FIXED_TOTAL_COST.toLocaleString(); // Set fixed cost
            updateFinancialSummary(); // Initial call
        }

        // Listen for the firebaseReady event dispatched from the head script
        console.log("MAIN SCRIPT: Adding event listener for firebaseReady.");
        document.addEventListener('firebaseReady', mainAppInitializer);
    </script>
</body>
</html>